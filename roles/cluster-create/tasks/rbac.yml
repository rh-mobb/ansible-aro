# make sure we have known subscription id and tenant id
# TODO - revisit this, may not be needed with azure_auth role. Or maybe move this logic in there
- name: Get subscription block
  when:
    - azr_subscription_id == "" or azr_tenant_id == ""
    # - _aro_check.clusters == {}
  block:
    - name: Get subscription
      azure.azcollection.azure_rm_subscription_info:
        all: true
      register: _subscription

    - name: Set Sub fact
      ansible.builtin.set_fact:
        azr_subscription_id: "{{ _subscription.subscriptions[0].subscription_id }}"
      when: azr_subscription_id == ""
    - name: Set tenant id
      ansible.builtin.set_fact:
        azr_tenant_id: "{{ _subscription.subscriptions[0].tenant_id }}"
      when: azr_tenant_id == ""


- name: Set ARO URL fact
  ansible.builtin.set_fact:
    app_display_name: "http://ansible-aro-{{ azr_resource_group }}-{{ azr_aro_cluster }}"

- name: Get all AD Applications from Tenant
  azure.azcollection.azure_rm_adapplication_info:
    tenant: "{{ azr_tenant_id }}"
  register: _ad_applications
  no_log: false # TODO - Change me back after troubleshooting

- name: Fail if app already exists
  ansible.builtin.fail:
    msg: "An AD application with display name '{{ app_display_name }}' already exists"
  when:
    - _ad_applications | json_query(jmesquery) != []
  vars:
    jmesquery: "applications[?app_display_name == `{{ app_display_name }}`]"

# Create AD application
- name: Create ad application
  azure.azcollection.azure_rm_adapplication:
    tenant: "{{ azr_tenant_id }}"
    display_name: "{{ app_display_name }}"
  register: _ad_application

- name: Set app facts
  ansible.builtin.set_fact:
    azr_service_principal_application_id: "{{ _ad_application.app_id }}"
    app_oid: "{{ _ad_application.object_id }}"

- name: Create ad sp
  azure.azcollection.azure_rm_adserviceprincipal:
    app_id: "{{ azr_service_principal_application_id }}"
    state: present
    tenant: "{{ azr_tenant_id }}"
  register: _ad_sp

- name: Wait a minute for AD sync new SP
  ansible.builtin.pause:
    minutes: 1

- name: Set sp_oid
  ansible.builtin.set_fact:
    sp_oid: "{{ _ad_sp.object_id }}"

- name: Create ad password
  azure.azcollection.azure_rm_adpassword:
    app_id: "{{ azr_service_principal_application_id }}"
    value: "{{ azr_service_principal_application_secret }}"
    tenant: "{{ azr_tenant_id }}"

# Get object id for role definition of ARO Subscription
- name: Obtain ARO Resource Group Role Definition Scope
  azure.azcollection.azure_rm_roledefinition_info:
    scope: "/subscriptions/{{ azr_subscription_id }}"
  register: sub_roledef_scope_output
  no_log: false # TODO - Change me back after troubleshooting

- name: Obtain Object ID of Contributor Role Definition
  ansible.builtin.set_fact:
    fact: "{{ sub_roledef_scope_output | json_query(jmesquery) }}"
  register: oid_sub_scope_query
  vars:
    jmesquery: "roledefinitions[?role_name == 'Contributor'].[id]"
  no_log: false # TODO - Change me back after troubleshooting

- name: Setting Object ID scope variable for the ARO Resource Group
  ansible.builtin.set_fact:
    sub_oid: "{{ oid_sub_scope_query.ansible_facts.fact[0][0] }}"

- name: Give ARO Subscription Contributor Role to the Service Principal
  azure.azcollection.azure_rm_roleassignment:
    scope: "/subscriptions/{{ azr_subscription_id }}"
    assignee_object_id: "{{ sp_oid }}"
    role_definition_id: "{{ sub_oid }}"
    tenant: "{{ azr_tenant_id }}"
    subscription_id: "{{ azr_subscription_id }}"
  retries: 10
  delay: 60

# Get object id for role definition of ARO resource group
- name: Obtain ARO Resource Group Role Definition Scope
  azure.azcollection.azure_rm_roledefinition_info:
    scope: "/subscriptions/{{ azr_subscription_id }}/resourceGroups/{{ azr_resource_group }}"
  register: rg_roledef_scope_output
  no_log: false # TODO - Change me back after troubleshooting

- name: Obtain Object ID of Contributor Role Definition
  ansible.builtin.set_fact:
    fact: "{{ rg_roledef_scope_output | json_query(jmesquery) }}"
  register: oid_rg_scope_query
  vars:
    jmesquery: "roledefinitions[?role_name == 'Network Contributor'].[id]"
  no_log: false # TODO - Change me back after troubleshooting

- name: Setting Object ID scope variable for the ARO Resource Group
  ansible.builtin.set_fact:
    rg_oid: "{{ oid_rg_scope_query.ansible_facts.fact[0][0] }}"

- name: Get AD Service Principal info
  when: azr_aro_provider_id == ""
  block:
    - name: Get ad sp info
      azure_rm_adserviceprincipal_info:
        display_name: "Azure Red Hat OpenShift RP"
        tenant: "{{ azr_tenant_id }}"
      register: _aro_rp_info

    - name: Set SP Fact
      ansible.builtin.set_fact:
        azr_aro_provider_id: "{{ _aro_rp_info.service_principals[0].object_id }}"


- name: Granting the ARO Resource Provider Contributor access to the ARO virtual network
  azure.azcollection.azure_rm_roleassignment:
    scope: "/subscriptions/{{ azr_subscription_id }}/resourceGroups/{{ azr_resource_group }}/providers/Microsoft.Network/virtualNetworks/{{ azr_virtual_network.name }}"
    assignee_object_id: "{{ azr_aro_provider_id }}"
    role_definition_id: "{{ rg_oid }}"

